"use strict";var Book=require("../models/book"),Author=require("../models/author"),Genre=require("../models/genre"),BookInstance=require("../models/bookinstance"),async=require("async"),_require=require("express-validator/check"),body=_require.body,validationResult=_require.validationResult,_require2=require("express-validator/filter"),sanitizeBody=_require2.sanitizeBody;exports.index=function(e,n){async.parallel({book_count:function(e){Book.count({},e)},book_instance_count:function(e){BookInstance.count({},e)},book_instance_available_count:function(e){BookInstance.count({status:"Available"},e)},author_count:function(e){Author.count({},e)},genre_count:function(e){Genre.count({},e)}},function(e,o){n.render("index",{title:"本地图书馆",error:e,data:o})})},exports.book_list=function(e,n){Book.find({},"title author").populate("author").exec(function(e,o){if(e)return next(e);n.render("book_list",{title:"Book List",book_list:o})})},exports.book_detail=function(o,n){async.parallel({book:function(e){Book.findById(o.params.id).populate("author").populate("genre").exec(e)},book_instance:function(e){BookInstance.find({book:o.params.id}).exec(e)}},function(e,o){return e?next(e):null==o.book?((e=new Error("Book not found")).status=404,next(e)):void n.render("book_detail",{title:"Title",book:o.book,book_instances:o.book_instance})})},exports.book_create_get=function(e,n){async.parallel({authors:function(e){Author.find(e)},genres:function(e){Genre.find(e)}},function(e,o){if(e)return next(e);n.render("book_form",{title:"Create Book",authors:o.authors,genres:o.genres})})},exports.book_create_post=[function(e,o,n){e.body.genre instanceof Array||(void 0===e.body.genre?e.body.genre=[]:e.body.genre=new Array(e.body.genre)),n()},body("title","Title must not be empty.").isLength({min:1}).trim(),body("author","Author must not be empty.").isLength({min:1}).trim(),body("summary","Summary must not be empty.").isLength({min:1}).trim(),body("isbn","ISBN must not be empty").isLength({min:1}).trim(),sanitizeBody("*").trim().escape(),sanitizeBody("genre.*").escape(),function(e,t,r){var i=validationResult(e),a=new Book({title:e.body.title,author:e.body.author,summary:e.body.summary,isbn:e.body.isbn,genre:e.body.genre});i.isEmpty()?a.save(function(e){if(e)return r(e);t.redirect(a.url)}):async.parallel({authors:function(e){Author.find(e)},genres:function(e){Genre.find(e)}},function(e,o){if(e)return r(e);for(var n=0;n<o.genres.length;n++)-1<a.genre.indexOf(o.genres[n]._id)&&(o.genres[n].checked="true");t.render("book_form",{title:"Create Book",authors:o.authors,genres:o.genres,book:a,errors:i.array()})})}],exports.book_delete_get=function(o,n){async.parallel({book_instances:function(e){BookInstance.find({book:o.params.id}).exec(e)},book:function(e){Book.findById(o.params.id).populate("author").populate("genre").exec(e)}},function(e,o){if(e)return next(e);null==o.book&&n.redirect("/catalog/book"),n.render("book_delete",{title:"Delete Book",book:o.book,book_instances:o.book_instances})})},exports.book_delete_post=function(n,t){async.parallel({book:function(e){Book.findById(n.body.bookid).exec(e)},book_instances:function(e){BookInstance.find({book:n.body.bookid}).exec(e)}},function(e,o){if(e)return next(e);0<o.book_instances.length?t.render("author_delete",{title:"Delete Book",book_instances:o.book_instances,book:o.book}):Book.findByIdAndRemove(n.body.bookid,function(e){if(e)return next(e);t.redirect("/catalog/books")})})},exports.book_update_get=function(o,r){async.parallel({book:function(e){Book.findById(o.params.id).populate("author").populate("genre").exec(e)},authors:function(e){Author.find(e)},genres:function(e){Genre.find(e)}},function(e,o){if(e)return next(e);if(null==o.book)return(e=new Error("Book not found")).status=404,next(e);for(var n=0;n<o.genres.length;n++)for(var t=0;t<o.book.genre.length;t++)o.genres[n]._id.toString()==o.book.genre[t]._id.toString()&&(o.genres[n].checked="true");r.render("book_form",{title:"Update Book",authors:o.authors,genres:o.genres,book:o.book})})},exports.book_update_post=[function(e,o,n){e.body.genre instanceof Array||(void 0===e.body.genre?e.body.genre=[]:e.body.genre=new Array(e.body.genre)),n()},body("title","Title must not be empty.").isLength({min:1}).trim(),body("author","Author must not be empty.").isLength({min:1}).trim(),body("summary","Summary must not be empty.").isLength({min:1}).trim(),body("isbn","ISBN must not be empty").isLength({min:1}).trim(),sanitizeBody("title").trim().escape(),sanitizeBody("author").trim().escape(),sanitizeBody("summary").trim().escape(),sanitizeBody("isbn").trim().escape(),sanitizeBody("genre.*").trim().escape(),function(e,t,r){var i=validationResult(e),a=new Book({title:e.body.title,author:e.body.author,summary:e.body.summary,isbn:e.body.isbn,genre:void 0===e.body.genre?[]:e.body.genre,_id:e.params.id});i.isEmpty()?Book.findByIdAndUpdate(e.params.id,a,{},function(e,o){if(e)return r(e);t.redirect(o.url)}):async.parallel({authors:function(e){Author.find(e)},genres:function(e){Genre.find(e)}},function(e,o){if(e)return r(e);for(var n=0;n<o.genres.length;n++)-1<a.genre.indexOf(o.genres[n]._id)&&(o.genres[n].checked="true");t.render("book_form",{title:"Update Book",authors:o.authors,genres:o.genres,book:a,errors:i.array()})})}];